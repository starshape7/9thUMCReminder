name: Weekly Discord Reminder

on:
  schedule:
    # 매주 화요일 16:00 KST = 매주 화요일 07:00 UTC
    - cron: "0 7 * * 2"
  workflow_dispatch: {}   # 수동 테스트 버튼

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Post to Discord
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}   # 리포 Secrets에 저장해둔 웹훅 URL
          START_DATE: "2025-09-22"                  # 1주차 시작(예: 월요일) KST 기준 날짜
        run: |
          node - <<'JS'
          const weekMs = 7*24*60*60*1000;

          // 1주차 시작일(KST 00:00)
          const startMs = new Date(process.env.START_DATE + 'T00:00:00+09:00').getTime();

          // 현재 시각(KST)
          const nowUtc = new Date();
          const nowKstMs = nowUtc.getTime() + 9*60*60*1000;

          // 주차 계산 (1부터 시작)
          let weeks = Math.floor((nowKstMs - startMs)/weekMs) + 1;
          if (weeks < 1) weeks = 1;

          const content =
          `@everyone
          📌 금일 ${weeks}주차 피드백 링크 제출 마감 안내
          - 피드백 링크 미첨부시 파트장에게 **1 out**이 부과되며, 3회 누적 시 탈부 대상이 될 수 있습니다.
          - 파트장 분들이 끝까지 완주하실 수 있도록 회장단 여러분께서도 함께 확인해주시면 감사하겠습니다.`;

          const payload = {
            content,
            allowed_mentions: { parse: ["everyone"] } // @everyone 허용
          };

          fetch(process.env.WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          }).then(async (r) => {
            if (!r.ok) throw new Error('Discord HTTP ' + r.status + ' ' + await r.text());
            console.log('Sent reminder for week', weeks);
          }).catch((e) => {
            console.error(e);
            process.exit(1);
          });
          JS
