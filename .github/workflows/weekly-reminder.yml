name: Weekly Discord Reminder

on:
  schedule:
    - cron: "0 7 * * 2"   # ë§¤ì£¼ í™”ìš”ì¼ 16:00 KST (UTC+9)
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Post to Discord
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
          START_DATE: "2025-09-22"   # 1ì£¼ì°¨ ì‹œìž‘ì¼(ì›”ìš”ì¼) KST
        shell: bash
        run: |
          set -euo pipefail
          cat > send.js <<'JS'
          const weekMs = 7*24*60*60*1000;
          const startMs = new Date(process.env.START_DATE + 'T00:00:00+09:00').getTime();
          const nowKstMs = Date.now() + 9*60*60*1000;

          let weeks = Math.floor((nowKstMs - startMs)/weekMs) + 1;
          if (weeks < 1) weeks = 1;

          const content = `@everyone
          
          ðŸ“Œ ê¸ˆì¼ ${weeks}ì£¼ì°¨ í”¼ë“œë°± ë§í¬ ì œì¶œ ë§ˆê° ì•ˆë‚´
          > - í”¼ë“œë°± ë§í¬ ë¯¸ê¸°ìž…ì‹œ ë§¤ì£¼ **1 out**ì´ ë¶€ê³¼ë˜ë©°, 3íšŒ ëˆ„ì  ì‹œ íƒˆë¶€ ëŒ€ìƒì´ ë  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
          > - íŒŒíŠ¸ìž¥ë¶„ë“¤ì´ ëê¹Œì§€ ì™„ì£¼í•˜ì‹¤ ìˆ˜ ìžˆë„ë¡ íšŒìž¥ë‹¨ ì—¬ëŸ¬ë¶„ê»˜ì„œë„ í•¨ê»˜ í™•ì¸í•´ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤.

          ê¶ê¸ˆí•œ ì ì´ë‚˜ ê±´ì˜ì‚¬í•­ì€ ì–¸ì œë“ ì§€ ë¬¸ì˜ì£¼ì„¸ìš”!
          ê°ì‚¬í•©ë‹ˆë‹¤.ðŸ˜Š`;
          
          const payload = {
            content,
            allowed_mentions: { parse: ["everyone"] }
          };

          fetch(process.env.WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          }).then(async (r) => {
            if (!r.ok) throw new Error('Discord HTTP ' + r.status + ' ' + await r.text());
            console.log('Sent reminder for week', weeks);
          }).catch((e) => {
            console.error(e);
            process.exit(1);
          });
          JS

          node send.js
