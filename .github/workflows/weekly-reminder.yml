name: Weekly Discord Reminder

on:
  schedule:
    # ë§¤ì£¼ í™”ìš”ì¼ 16:00 KST = ë§¤ì£¼ í™”ìš”ì¼ 07:00 UTC
    - cron: "0 7 * * 2"
  workflow_dispatch: {}   # ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ë²„íŠ¼

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Post to Discord
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}   # ë¦¬í¬ Secretsì— ì €ì¥í•´ë‘” ì›¹í›… URL
          START_DATE: "2025-09-22"                  # 1ì£¼ì°¨ ì‹œì‘(ì˜ˆ: ì›”ìš”ì¼) KST ê¸°ì¤€ ë‚ ì§œ
        run: |
          node - <<'JS'
          const weekMs = 7*24*60*60*1000;

          // 1ì£¼ì°¨ ì‹œì‘ì¼(KST 00:00)
          const startMs = new Date(process.env.START_DATE + 'T00:00:00+09:00').getTime();

          // í˜„ì¬ ì‹œê°(KST)
          const nowUtc = new Date();
          const nowKstMs = nowUtc.getTime() + 9*60*60*1000;

          // ì£¼ì°¨ ê³„ì‚° (1ë¶€í„° ì‹œì‘)
          let weeks = Math.floor((nowKstMs - startMs)/weekMs) + 1;
          if (weeks < 1) weeks = 1;

          const content =
          `@everyone
          ğŸ“Œ ê¸ˆì¼ ${weeks}ì£¼ì°¨ í”¼ë“œë°± ë§í¬ ì œì¶œ ë§ˆê° ì•ˆë‚´
          - í”¼ë“œë°± ë§í¬ ë¯¸ì²¨ë¶€ì‹œ íŒŒíŠ¸ì¥ì—ê²Œ **1 out**ì´ ë¶€ê³¼ë˜ë©°, 3íšŒ ëˆ„ì  ì‹œ íƒˆë¶€ ëŒ€ìƒì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          - íŒŒíŠ¸ì¥ ë¶„ë“¤ì´ ëê¹Œì§€ ì™„ì£¼í•˜ì‹¤ ìˆ˜ ìˆë„ë¡ íšŒì¥ë‹¨ ì—¬ëŸ¬ë¶„ê»˜ì„œë„ í•¨ê»˜ í™•ì¸í•´ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤.`;

          const payload = {
            content,
            allowed_mentions: { parse: ["everyone"] } // @everyone í—ˆìš©
          };

          fetch(process.env.WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          }).then(async (r) => {
            if (!r.ok) throw new Error('Discord HTTP ' + r.status + ' ' + await r.text());
            console.log('Sent reminder for week', weeks);
          }).catch((e) => {
            console.error(e);
            process.exit(1);
          });
          JS
